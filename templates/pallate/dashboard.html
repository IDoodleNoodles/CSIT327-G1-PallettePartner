{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard | PallettePartner{% endblock %}

{% block content %}
<div class="min-h-screen flex bg-[#050819] text-[#E5E7EB]">

  <style>
    /* Artistic dropdown + buttons styling */
    #categoryDropdown {
      background: linear-gradient(180deg, rgba(13,16,30,0.98) 0%, rgba(18,21,38,0.95) 100%);
      box-shadow: 0 8px 30px rgba(11,14,30,0.6);
      border-radius: 14px;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(139,92,246,0.12);
    }

    #categoryDropdown label { cursor: pointer; }

    /* check icon animation */
    .check-icon { transition: transform 180ms ease, opacity 180ms ease; transform-origin: center; }
    .check-icon.text-transparent { opacity: 0; transform: scale(0.8) translateX(4px); }
    .check-icon.text-\[\#8B5CF6\] { opacity: 1; transform: scale(1) translateX(0); }

    /* Apply/Clear buttons */
    #categoryApply,
    #categoryClear {
      transition: transform .18s ease, box-shadow .18s ease;
    }
    #categoryApply:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 6px 18px rgba(139,92,246,0.24); }
    #categoryClear:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.28); }

    /* Floating create button animation */
    @keyframes floatPop { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(-6px) scale(1.02); } 100% { transform: translateY(0) scale(1); } }
    #addPostBtn { animation: floatPop 4s ease-in-out infinite; box-shadow: 0 10px 30px rgba(167,243,208,0.12); }

    /* Card hover effect */
    .recent-upload-card { transition: transform .28s cubic-bezier(.2,.9,.3,1), box-shadow .28s ease, background .18s ease; }
    .recent-upload-card:hover { transform: translateY(-8px); box-shadow: 0 18px 40px rgba(2,6,23,0.6); }

    /* Make icons pop on hover */
    .recent-upload-card .flex.items-center a img,
    .recent-upload-card .open-comments img { transition: transform .16s ease, filter .16s ease; }
    .recent-upload-card .flex.items-center a:hover img,
    .recent-upload-card .open-comments:hover img { transform: scale(1.08); filter: drop-shadow(0 6px 10px rgba(139,92,246,0.12)); }

    /* Dropdown scrollbar styling */
    #categoryDropdown .max-h-44::-webkit-scrollbar { width: 8px; }
    #categoryDropdown .max-h-44::-webkit-scrollbar-thumb { background: linear-gradient(180deg,#5B21B6,#8B5CF6); border-radius: 999px; }
  </style>

  <!-- Mobile Overlay -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

  <!-- LEFT MENU -->
  <aside id="sidebar"
         class="bg-[#050819] w-64 flex-shrink-0 flex flex-col py-8 px-6 border-r border-[#111827] shadow-xl h-screen fixed top-0 left-0 z-40">

    <h1 class="text-base font-semibold text-white flex items-center gap-2 mb-8">
      <span>Menu</span>
    </h1>

    <nav class="flex flex-col gap-3 text-sm font-medium text-[#CBD5F5]">

      <a href="{% url 'pallate:dashboard' %}"
         class="flex items-center gap-3 px-3 py-2 rounded-lg
                {% if request.path == '/dashboard/' %}bg-[#12172D] text-white{% else %}hover:bg-[#12172D] hover:text-white{% endif %}">
        <img src="{% static 'icon/home_icon.png' %}" class="w-5 h-5" alt="Home">
        <span>Dashboard</span>
      </a>

      <a href="{% url 'pallate:artist_profile_by_id' request.user.id %}"
         class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#12172D] hover:text-white">
        <img src="{% static 'icon/artist_icon.png' %}" class="w-5 h-5" alt="Artists">
        <span>Artist</span>
      </a>

      <a href="{% url 'pallate:collaboration_detail_legacy' %}"
         class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#12172D] hover:text-white">
        <img src="{% static 'icon/collabpost_icon.png' %}" class="w-5 h-5" alt="Collaboration">
        <span>Collaboration</span>
      </a>

      <a href="{% url 'pallate:upload_artwork' %}"
         class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#12172D] hover:text-white">
        <img src="{% static 'icon/upload_artwork_icon.png' %}" class="w-5 h-5" alt="Upload">
        <span>Upload Artworks</span>
      </a>

      <a href="{% url 'pallate:favorites' %}"
         class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#12172D] hover:text-white">
        <img src="{% static 'icon/favorite_icon.png' %}" class="w-5 h-5" alt="Favorites">
        <span>Favorites</span>
      </a>

      <a href="{% url 'pallate:profile' %}"
         class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#12172D] hover:text-white">
        <img src="{% static 'icon/profile_icon.png' %}" class="w-5 h-5" alt="Profile">
        <span>My Profile</span>
      </a>

      <!-- New Features -->
      <div class="pt-3 mt-3 border-t border-[#111827]">
        <p class="text-xs text-gray-500 mb-2 px-3">DISCOVER</p>
        
        <a href="{% url 'pallate:find_collaborators' %}"
           class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#12172D] hover:text-white">
          <span class="text-lg">ü§ù</span>
          <span>Find Collaborators</span>
        </a>

        <a href="{% url 'pallate:featured_artists' %}"
           class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#12172D] hover:text-white">
          <span class="text-lg">‚≠ê</span>
          <span>Featured Artists</span>
        </a>
      </div>
    </nav>

    <div class="mt-auto pt-8 border-t border-[#111827]">
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#12172D] hover:text-white text-sm">
        <img src="{% static 'icon/settings_icon.png' %}" class="w-5 h-5" alt="Settings">
        <span>Settings</span>
      </a>
    </div>
  </aside>

  <!-- RIGHT CONTENT AREA -->
  <main class="flex-1 flex flex-col bg-[#050819] overflow-y-auto relative ml-64">

    <!-- TOP NAV BAR -->
    <header class="flex items-center justify-between px-10 py-4 bg-[#050819] sticky top-0 z-20">
      <div class="flex items-center gap-10 w-full">
        <div class="text-xl font-semibold text-white">
          <span class="text-white">Palette</span><span class="text-[#8B5CF6]">Partners</span>
        </div>

        <form method="get" action="{% url 'pallate:search' %}" class="flex items-center w-full max-w-xl bg-card-dark border border-border-dark rounded-md px-4 py-2 shadow">
          <img src="{% static 'icon/search_icon.png' %}"
               class="w-4 h-4 opacity-80 mr-2" alt="">
          <input type="text" 
                 name="q" 
                 placeholder="Search projects, artist"
                 class="bg-transparent text-sm w-full text-text-light placeholder-muted focus:outline-none">
        </form>
      </div>

      <div class="flex items-center gap-4">
        
        <!-- NOTIFICATION DROPDOWN -->
        <div class="relative">
          <button id="notifToggle"
                  type="button"
                  class="relative hover:opacity-80 transition flex items-center justify-center">
            <img src="{% static 'icon/notification_icon.png' %}" class="w-5 h-5" alt="Notifications">
            {% if unread_count and unread_count > 0 %}
              <span class="absolute -top-1 -right-1 w-2 h-2 bg-[#A7F3D0] rounded-full"></span>
            {% endif %}
          </button>

          <div id="notifDropdown"
               class="hidden absolute right-0 mt-3 w-80 bg-[#050819] border border-[#232B46] rounded-2xl shadow-2xl z-50">

            <div class="flex items-center justify-between px-4 py-3 border-b border-[#111827]">
              <div>
                <p class="text-sm font-semibold text-[#E5E7EB]">Notifications</p>
                <p class="text-[11px] text-muted">
                  {% if unread_count and unread_count > 0 %}
                    You have {{ unread_count }} unread
                  {% else %}
                    You're all caught up üëå
                  {% endif %}
                </p>
              </div>
              {% if unread_count and unread_count > 0 %}
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-[#A7F3D0] text-[11px] font-semibold text-[#050819]">
                  {{ unread_count }}
                </span>
              {% endif %}
            </div>

            <div class="max-h-80 overflow-y-auto py-2">
              {% if notifications %}
                {% for n in notifications %}
                  <a href="{{ n.target_url|default:'#' }}"
                     class="flex items-start gap-3 px-4 py-3 hover:bg-[#0B1024] transition relative">

                    {% if not n.is_read %}
                      <span class="absolute left-2 top-1.5 w-2 h-2 bg-[#A7F3D0] rounded-full"></span>
                    {% endif %}

                    <div class="flex-shrink-0 mt-0.5 w-8 h-8 rounded-full bg-[#0B1024] flex items-center justify-center">
                      {% if n.notification_type == 'comment' %}
                        <img src="{% static 'icon/comment_icon.png' %}" class="w-4 h-4" alt="Comment">
                      {% elif n.notification_type == 'message' %}
                        <img src="{% static 'icon/message_icon.png' %}" class="w-4 h-4" alt="Message">
                      {% elif n.notification_type == 'collab' %}
                        <img src="{% static 'icon/collabpost_icon.png' %}" class="w-4 h-4" alt="Collaboration">
                      {% else %}
                        <img src="{% static 'icon/notification_icon.png' %}" class="w-4 h-4" alt="Notification">
                      {% endif %}
                    </div>

                    <div class="flex-1">
                      <p class="text-xs font-semibold text-[#E5E7EB]">
                        {% if n.actor %}
                          {{ n.actor.username }}
                        {% else %}
                          System
                        {% endif %}
                      </p>

                      <p class="text-xs text-muted">
                        {% if n.notification_type == 'comment' %}
                          commented on your artwork
                        {% elif n.notification_type == 'message' %}
                          sent you a message
                        {% elif n.notification_type == 'collab' %}
                          requested to collaborate
                        {% else %}
                          {{ n.message }}
                        {% endif %}
                      </p>

                      <p class="text-[10px] text-muted mt-1">
                        {{ n.created_at|timesince }} ago
                      </p>
                    </div>
                  </a>
                {% endfor %}
              {% else %}
                <div class="px-4 py-6 text-center text-xs text-[#9CA3AF]">
                  No notifications.
                </div>
              {% endif %}
            </div>

            <div class="flex items-center justify-between px-4 py-3 border-t border-[#111827] text-xs">
              <a href="#" class="px-3 py-1.5 rounded-full bg-[#111827] hover:bg-[#1F2937] text-[#E5E7EB]">
                Show more
              </a>
              <button type="button"
                      id="notifClose"
                      class="px-3 py-1.5 rounded-full bg-[#1F2937] hover:bg-[#374151] text-[#E5E7EB]">
                Close
              </button>
            </div>
          </div>
        </div>

        <!-- LOGOUT BUTTON -->
        <form action="{% url 'pallate:logout' %}" method="post">
          {% csrf_token %}
          <button type="submit"
                  class="bg-[#8B5CF6] hover:bg-[#7C3AED] text-white font-semibold px-5 py-1.5 rounded-full text-sm transition">
            Logout
          </button>
        </form>
      </div>
    </header>

    <!-- HERO BANNER -->  
    <section class="relative px-10 pt-2 mb-2">
      <div class="relative w-full h-32 md:h-40 rounded-t-3xl overflow-hidden">
        <img src="{% static 'icon/dashboard_banner.jpg' %}" onerror="this.style.display='none'"
             class="w-full h-full object-cover" alt="Banner">

        <div class="absolute inset-0 bg-gradient-to-r from-[#050819]/90 via-[#050819]/40 to-transparent flex flex-col justify-center px-10">
          <h1 class="text-3xl md:text-4xl font-bold text-text-light tracking-tight drop-shadow-sm">
            Hello, {{ request.user.first_name|default:request.user.username }}!
          </h1>
          <p class="text-sm md:text-base text-muted mt-1 drop-shadow-sm">
            Explore new artworks and collaboration opportunities.
          </p>
        </div>
      </div>
    </section>

    <!-- MAIN CARDS ROW -->
    <section class="px-10 pb-5 pt-3 -mt-3 bg-[#050819]">
      <div class="grid gap-6 lg:grid-cols-[minmax(0,_2.4fr)_minmax(260px,_1fr)]">

        <!-- RECENT UPLOADS -->
        <div class="bg-[#050819] rounded-3xl shadow-2xl border border-[#1F2937] px-6 py-6" style="overflow: visible;">
          <div class="flex justify-between items-center mb-4 section-header">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
              <span></span> Recent Uploads
            </h2>
            
              <!-- Category Filter Dropdown (multi-select) -->
              <div class="relative">
                <span class="text-sm text-muted mr-2 self-center mr-3">Filter:</span>
                <button id="categoryDropdownToggle" type="button"
                        class="inline-flex items-center gap-2 px-3 py-1 text-sm rounded-full bg-[#1A2035] text-[#E5E7EB] border border-[#232B46] hover:bg-[#8B5CF6] hover:text-white transition duration-200">
                  <span id="selectedCategoriesText">All</span>
                  <svg class="w-4 h-4 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                <div id="categoryDropdown" class="hidden absolute right-0 mt-2 w-64 bg-card-dark border border-border-dark rounded-lg shadow-lg z-50 p-3">
                  <div class="flex items-center gap-2 mb-2">
                    <input id="cat_all" type="checkbox" data-category="all" class="h-4 w-4" checked>
                    <label for="cat_all" class="text-sm text-text-light">All</label>
                  </div>

                  <div class="max-h-44 overflow-y-auto py-1">
                    {% for category in all_categories %}
                    <label class="flex items-center justify-between gap-2 py-1">
                      <div class="flex items-center gap-2">
                        <input type="checkbox" class="category-checkbox h-4 w-4" data-category="{{ category }}" id="cat_{{ forloop.counter }}">
                        <span class="text-sm text-text-light">{{ category }}</span>
                      </div>
                      <svg class="w-4 h-4 text-transparent check-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 00-1.414-1.414L8 11.172 4.707 7.879a1 1 0 00-1.414 1.414l4 4a1 1 0 001.414 0l8-8z" clip-rule="evenodd" />
                      </svg>
                    </label>
                    {% endfor %}
                  </div>

                  <div class="pt-3 flex justify-end gap-2">
                    <button id="categoryClear" type="button" class="px-3 py-1 rounded-full bg-[#232B46] hover:bg-[#374151] text-text-light text-sm">Clear</button>
                    <button id="categoryApply" type="button" class="px-3 py-1 rounded-full bg-[#8B5CF6] hover:bg-[#7C3AED] text-white text-sm">Apply</button>
                  </div>
                </div>
              </div>
          </div>

          {% if artworks %}
            <div id="recentUploadsScroller"
                 class="flex flex-col gap-3 max-h-[460px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-[#374151] scrollbar-track-transparent hover:scrollbar-thumb-[#4B5563] snap-y snap-mandatory">

              <!-- Loading indicator -->
              <div id="loadingIndicator" class="hidden text-center py-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-[#8B5CF6]"></div>
              </div>

              {% for artwork in artworks %}
              <!-- Card layout like reference UI -->
              <div class="snap-start grid md:grid-cols-[minmax(0,_1.3fr)_minmax(260px,_1fr)] gap-4 bg-card-dark border border-border-dark rounded-3xl p-4 shadow recent-upload-card">
                
                <!-- LEFT: text/info -->
                <div class="flex flex-col justify-between text-text-light">
                  <div>
                    <p class="text-xs text-muted mb-1 flex items-center gap-1">
                      <span>üìã</span> Project Title
                    </p>
                    <h3 class="text-base font-semibold text-white">{{ artwork.title }}</h3>
                    <p class="text-xs text-gray-400 mt-1 line-clamp-2">
                      {{ artwork.description }}
                    </p>

                    <!-- Categories -->
                    {% if artwork.get_categories_list %}
                    <div class="mt-2 flex flex-wrap gap-1">
                      {% for cat in artwork.get_categories_list %}
                        <span class="px-2 py-1 text-xs rounded-full bg-[#8B5CF6]/20 text-[#E9D5FF] border border-[#8B5CF6]/30 category-tag">
                          {{ cat }}
                        </span>
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>

                  <div class="mt-3 text-[11px] text-muted flex items-center gap-1">
                    <span>‚è±Ô∏è</span> {{ artwork.created_at|timesince }} ago
                  </div>

                  <div class="mt-3 flex items-center gap-3">
                    <!-- Visit artist profile -->
                    <a href="{% url 'pallate:artist_profile_by_id' artwork.user.id %}"
                       class="flex items-center justify-center w-8 h-8 rounded-full bg-[#111827] hover:bg-[#1F2937] transition"
                       title="Artist Profile">
                      <img src="{% static 'icon/artist_icon.png' %}" class="w-4 h-4" alt="Artist">
                    </a>

                    <!-- Favorite -->
                    {% if artwork.id %}
                    <a href="{% url 'pallate:toggle_favorite' artwork.id %}"
                       class="toggle-favorite flex items-center justify-center w-8 h-8 rounded-full bg-[#111827] hover:bg-[#1F2937] transition"
                       title="{% if artwork.id in user_favorites %}Remove from favorites{% else %}Add to favorites{% endif %}">
                      {% if artwork.id in user_favorites %}
                        <svg class="w-4 h-4 text-[#8B5CF6]" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                        </svg>
                      {% else %}
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                      {% endif %}
                      <span class="ml-1 text-[11px] text-gray-300">
                        {{ artwork.favorites.count }}
                      </span>
                    </a>
                    {% endif %}

                    <!-- Comments -->
                    {% if artwork.id %}
                    <button type="button"
                            class="open-comments flex items-center gap-1 px-2 py-1 rounded-full bg-[#111827] hover:bg-[#1F2937] transition"
                            data-comments-url="{% url 'pallate:artwork_comments' artwork.id %}"
                            title="View comments">
                      <img src="{% static 'icon/comment_icon.png' %}" class="w-4 h-4" alt="Comments">
                      <span class="text-[11px] text-gray-200">
                        {{ artwork.comment_count|default:0 }}
                      </span>
                    </button>
                    {% endif %}
                  </div>
                </div>

                <!-- RIGHT: image -->
                <div class="rounded-3xl bg-[#0F172A] flex items-center justify-center overflow-hidden min-h-[210px] relative">
                  {% if artwork.image %}
                    <img src="{{ artwork.image.url }}" alt="{{ artwork.title }}"
                         class="w-full h-full object-cover transition duration-300">
                    <div class="absolute inset-0 bg-gradient-to-t from-[#050819] to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-end justify-start p-4">
                      <span class="text-white text-sm font-semibold truncate max-w-full">
                        {{ artwork.title }}
                      </span>
                    </div>
                  {% else %}
                    <span class="text-sm text-gray-300">üñºÔ∏è Image here</span>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center text-muted text-sm border border-dashed border-[#374151] rounded-2xl py-16 bg-[#050819]">
              <p class="mb-2">üé®</p>
              <p>No artworks yet. Be the first to upload your art!</p>
            </div>
          {% endif %}
        </div>

        <!-- ACTIVE ARTIST PANEL -->
        <aside class="bg-[#050819] rounded-3xl shadow-2xl border border-[#1F2937] px-5 py-6">
          <h2 class="text-base font-semibold text-[#C4B5FD] mb-4">Active Artist</h2>

          {% if posts %}
            <div class="flex flex-col gap-3">
              {% for post in posts|slice:":5" %}
              <div class="flex items-center justify-between bg-card-dark border border-border-dark rounded-2xl px-4 py-3 shadow">
                <div class="flex items-center gap-3">
                  <div class="w-9 h-9 rounded-full bg-[#232B46] flex items-center justify-center text-xs font-semibold text-text-light">
                    {{ post.owner.first_name|default:post.owner.username|first|upper }}
                  </div>
                  <div class="text-text-light">
                    <p class="text-sm font-medium">{{ post.owner.first_name|default:post.owner.username }}</p>
                    <p class="text-[11px] text-muted">
                      {{ post.created_at|timesince }} ago
                    </p>
                  </div>
                </div>
                <a href="{% url 'pallate:collab_messages' post.id %}"
                   class="w-9 h-9 flex items-center justify-center rounded-full bg-[#232B46] hover:bg-[#374151] transition"
                   title="Message">
                  <img src="{% static 'icon/message_icon.png' %}" class="w-4 h-4" alt="Message">
                </a>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center text-muted text-sm border border-dashed border-[#374151] rounded-2xl py-6 bg-[#050819]">
              No active artists yet.
            </div>
          {% endif %}
        </aside>
      </div>
    </section>

    <!-- FLOATING CREATE BUTTON -->
    <button id="addPostBtn"
            class="fixed bottom-8 right-8 bg-[#A7F3D0] hover:bg-[#7BE5B4] text-[#0A0A1F] text-3xl font-bold rounded-full w-14 h-14 shadow-lg flex items-center justify-center transition-all duration-300 z-40">
      +
    </button>

    <!-- MODAL OVERLAY + CONTENT -->
    <div id="overlay" class="overlay"></div>

    <div id="createModal" class="modal">
      <div class="modal-content bg-card-dark border border-border-dark p-6 rounded-2xl text-text-light max-w-4xl mx-auto shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="bg-[#0B1024] rounded-2xl p-5">
          <h2 class="text-xl font-semibold text-[#A7F3D0] mb-4 text-center">Create New Collaboration</h2>
          <form method="POST" class="space-y-4">
            {% csrf_token %}

            <div class="space-y-1">
              <label for="id_title" class="text-sm font-medium text-muted">Title:</label>
              <input id="id_title" name="title" type="text"
                     value="{{ form.title.value|default:'' }}"
                     placeholder="Project Title"
                     class="w-full bg-[#0F172A] border border-border-dark rounded-xl px-4 py-2 text-sm text-text-light placeholder-muted focus:outline-none focus:ring-2 focus:ring-[#A7F3D0]"
                     required />
            </div>

            <div class="space-y-1">
              <label for="id_description" class="text-sm font-medium text-muted">Description:</label>
              <textarea id="id_description" name="description" rows="4"
                        placeholder="Describe your project..."
                        class="w-full bg-[#0F172A] border border-border-dark rounded-xl px-4 py-2 text-sm text-text-light placeholder-muted focus:outline-none focus:ring-2 focus:ring-[#A7F3D0]"
                        required>{{ form.description.value|default:'' }}</textarea>
            </div>

            <div class="space-y-1">
              <label for="id_project_type" class="text-sm font-medium text-muted">Project Type:</label>
              <input id="id_project_type" name="project_type" type="text"
                     value="{{ form.project_type.value|default:'' }}"
                     placeholder="e.g., Illustration, Book Cover, Fantasy Art"
                     class="w-full bg-[#0F172A] border border-border-dark rounded-xl px-4 py-2 text-sm text-text-light placeholder-muted focus:outline-none focus:ring-2 focus:ring-[#A7F3D0]" />
            </div>

            <div class="space-y-1">
              <label for="id_tags" class="text-sm font-medium text-muted">Tags:</label>
              <input id="id_tags" name="tags" type="text"
                     value="{{ form.tags.value|default:'' }}"
                     placeholder="Comma-separated tags (e.g., Fantasy, Book Cover, Digital)"
                     class="w-full bg-[#0F172A] border border-border-dark rounded-xl px-4 py-2 text-sm text-text-light placeholder-muted focus:outline-none focus:ring-2 focus:ring-[#A7F3D0]" />
            </div>

            <div class="space-y-1">
              <label for="id_requirements" class="text-sm font-medium text-muted">Requirements:</label>
              <textarea id="id_requirements" name="requirements" rows="3"
                        placeholder="List project requirements (one per line)"
                        class="w-full bg-[#0F172A] border border-border-dark rounded-xl px-4 py-2 text-sm text-text-light placeholder-muted focus:outline-none focus:ring-2 focus:ring-[#A7F3D0]">{{ form.requirements.value|default:'' }}</textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-1">
                <label for="id_deadline" class="text-sm font-medium text-muted">Deadline:</label>
                <input id="id_deadline" name="deadline" type="date"
                       value="{{ form.deadline.value|default:'' }}"
                       class="w-full bg-[#0F172A] border border-border-dark rounded-xl px-4 py-2 text-sm text-text-light placeholder-muted focus:outline-none focus:ring-2 focus:ring-[#A7F3D0]" />
              </div>

              <div class="space-y-1">
                <label for="id_budget" class="text-sm font-medium text-muted">Budget:</label>
                <input id="id_budget" name="budget" type="text"
                       value="{{ form.budget.value|default:'' }}"
                       placeholder="e.g., $500, Revenue Share"
                       class="w-full bg-[#0F172A] border border-border-dark rounded-xl px-4 py-2 text-sm text-text-light placeholder-muted focus:outline-none focus:ring-2 focus:ring-[#A7F3D0]" />
              </div>
            </div>

            <div class="flex justify-end gap-3 pt-2">
              <button type="button" id="closeModal"
                      class="px-4 py-2 rounded-full bg-[#232B46] hover:bg-[#374151] text-text-light text-sm transition">
                Cancel
              </button>
              <button type="submit"
                      class="px-4 py-2 rounded-full bg-[#A7F3D0] hover:bg-[#7BE5B4] text-[#0A0A1F] font-semibold text-sm transition">
                Post
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- SCROLL TO TOP -->
    <button id="scrollToTop"
      class="fixed bottom-6 right-6 bg-[#A7F3D0] hover:bg-[#7BE5B4] text-[#0A0A1F] p-3 rounded-full shadow-lg transition-all duration-300 opacity-0 pointer-events-none z-50"
      title="Scroll to top">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
      </svg>
    </button>

    <!-- FLOATING COMMENTS PANEL -->
    <div id="commentsPanel"
         class="hidden fixed z-50 top-24 right-10 bg-[#050819] border border-[#1F2937] rounded-2xl shadow-2xl flex flex-col"
         style="width: 480px; height: 420px;">
      <div id="commentsPanelHeader"
           class="cursor-move flex items-center justify-between px-4 py-2 border-b border-[#1F2937]">
        <span class="text-sm font-semibold">Comments</span>
        <button id="closeCommentsPanel"
                class="text-lg leading-none px-2 hover:text-red-400">
          &times;
        </button>
      </div>
      <iframe id="commentsFrame"
              src=""
              class="flex-1 w-full border-0 rounded-b-2xl bg-[#050819]">
      </iframe>
    </div>

  </main>
</div>

<!-- Category filter dropdown script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  var toggle = document.getElementById('categoryDropdownToggle');
  var dropdown = document.getElementById('categoryDropdown');
  var catAll = document.getElementById('cat_all');
  var checkboxes = Array.from(document.querySelectorAll('.category-checkbox'));
  var applyBtn = document.getElementById('categoryApply');
  var clearBtn = document.getElementById('categoryClear');
  var selectedText = document.getElementById('selectedCategoriesText');

  function closeDropdown() { dropdown.classList.add('hidden'); }
  function openDropdown() { dropdown.classList.remove('hidden'); }

  // Toggle dropdown
  if (toggle) toggle.addEventListener('click', function(e) {
    e.stopPropagation();
    dropdown.classList.toggle('hidden');
  });

  // Click outside to close
  document.addEventListener('click', function(e) {
    if (!dropdown.contains(e.target) && !toggle.contains(e.target)) {
      closeDropdown();
    }
  });

  // When 'All' is checked -> uncheck others
  if (catAll) {
    catAll.addEventListener('change', function() {
      if (catAll.checked) {
        checkboxes.forEach(function(cb){ cb.checked = false; toggleCheckIcon(cb); });
        updateSelectedText();
      }
    });
  }

  function toggleCheckIcon(cb) {
    var label = cb.closest('label');
    if (!label) return;
    var icon = label.querySelector('.check-icon');
    if (!icon) return;
    if (cb.checked) {
      icon.classList.remove('text-transparent');
      icon.classList.add('text-[#8B5CF6]');
    } else {
      icon.classList.add('text-transparent');
      icon.classList.remove('text-[#8B5CF6]');
    }
  }

  checkboxes.forEach(function(cb) {
    cb.addEventListener('change', function() {
      if (cb.checked) {
        if (catAll) { catAll.checked = false; }
      }
      toggleCheckIcon(cb);
    });
  });

  function getSelectedCategories() {
    var selected = checkboxes.filter(function(cb){ return cb.checked; }).map(function(cb){ return cb.getAttribute('data-category'); });
    return selected;
  }

  function updateSelectedText() {
    var selected = getSelectedCategories();
    if (selected.length === 0) {
      selectedText.textContent = 'All';
    } else if (selected.length === 1) {
      selectedText.textContent = selected[0];
    } else {
      selectedText.textContent = selected.length + ' selected';
    }
  }

  clearBtn.addEventListener('click', function() {
    checkboxes.forEach(function(cb){ cb.checked = false; toggleCheckIcon(cb); });
    if (catAll) catAll.checked = true;
    updateSelectedText();
  });

  // Reuse the existing loading and rendering logic but driven by selected categories
  applyBtn.addEventListener('click', function() {
    var activeCategories = getSelectedCategories();
    if (!activeCategories || activeCategories.length === 0) {
      // treat as 'all' -> reload to show all
      window.location.href = window.location.pathname;
      return;
    }

    updateSelectedText();
    closeDropdown();

    var loadingIndicator = document.getElementById('loadingIndicator');
    var recentUploadsScroller = document.getElementById('recentUploadsScroller');
    if (loadingIndicator && recentUploadsScroller) {
      recentUploadsScroller.innerHTML = '';
      loadingIndicator.classList.remove('hidden');
    }

    var params = new URLSearchParams();
    params.append('categories', activeCategories.join(','));

    var csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
    var csrfToken = csrfTokenElement ? csrfTokenElement.getAttribute('content') : '';

    fetch('/api/fetch-artworks-by-category/?' + params.toString(), {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrfToken
      }
    })
    .then(function(response){ if (!response.ok) throw new Error('Network response was not ok'); return response.json(); })
    .then(function(data){
      if (loadingIndicator) loadingIndicator.classList.add('hidden');
      if (!data.artworks || data.artworks.length === 0) {
        if (recentUploadsScroller) recentUploadsScroller.innerHTML = `
          <div class="text-center text-muted text-sm border border-dashed border-[#374151] rounded-2xl py-10 bg-[#050819]">
            <p class="mb-2">üé®</p>
            <p>No artworks found for the selected categories.</p>
            <p class="text-xs mt-2">Try selecting different categories or upload your own artwork!</p>
          </div>`;
        return;
      }

      var html = '';
      data.artworks.forEach(function(artwork) {
        var createdDate = new Date(artwork.created_at || Date.now());
        var createdText = createdDate.toLocaleDateString() + ' at ' + createdDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        var categories = artwork.categories || [];
        var categoryChips = categories.map(function(cat){ return '<span class="px-2 py-1 text-xs rounded-full bg-[#8B5CF6]/20 text-[#E9D5FF] border border-[#8B5CF6]/30 category-tag">' + cat + '</span>'; }).join('');

        html += `
          <div class="snap-start grid md:grid-cols-[minmax(0,_1.3fr)_minmax(260px,_1fr)] gap-4 bg-card-dark border border-border-dark rounded-3xl p-4 shadow recent-upload-card">
            <div class="flex flex-col justify-between text-text-light">
              <div>
                <p class="text-xs text-muted mb-1 flex items-center gap-1"><span>üìã</span> Project Title</p>
                <h3 class="text-base font-semibold text-white">${artwork.title || ''}</h3>
                <p class="text-xs text-gray-400 mt-1 line-clamp-2">${artwork.description || ''}</p>
                ${categories.length ? '<div class="mt-2 flex flex-wrap gap-1">' + categoryChips + '</div>' : ''}
              </div>
              <div class="mt-3 text-[11px] text-muted flex items-center gap-1"><span>‚è±Ô∏è</span> ${createdText}</div>
              <div class="mt-3 flex items-center gap-3">
                <a href="/artist/${artwork.user_id}/" class="flex items-center justify-center w-8 h-8 rounded-full bg-[#111827] hover:bg-[#1F2937] transition" title="Artist Profile">
                  <img src="{% static 'icon/artist_icon.png' %}" class="w-4 h-4" alt="Artist">
                </a>
                ${artwork.id ? `<a href="/toggle-favorite/${artwork.id}/" class="toggle-favorite flex items-center justify-center w-8 h-8 rounded-full bg-[#111827] hover:bg-[#1F2937] transition" title="Add to favorites"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg><span class="ml-1 text-[11px] text-gray-300">${artwork.favorite_count || 0}</span></a>` : ''}
                ${artwork.id ? `<button type="button" class="open-comments flex items-center gap-1 px-2 py-1 rounded-full bg-[#111827] hover:bg-[#1F2937] transition" data-comments-url="/artwork/${artwork.id}/comments/" title="View comments"><img src="{% static 'icon/comment_icon.png' %}" class="w-4 h-4" alt="Comments"><span class="text-[11px] text-gray-200">${artwork.comment_count || 0}</span></button>` : ''}
              </div>
            </div>
            <div class="rounded-3xl bg-[#0F172A] flex items-center justify-center overflow-hidden min-h-[210px] relative">
              ${artwork.image_url ? `<img src="${artwork.image_url}" alt="${artwork.title || ''}" class="w-full h-full object-cover transition duration-300"><div class="absolute inset-0 bg-gradient-to-t from-[#050819] to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-end justify-start p-4"><span class="text-white text-sm font-semibold truncate max-w-full">${artwork.title || ''}</span></div>` : '<span class="text-sm text-gray-300">üñºÔ∏è Image here</span>'}
            </div>
          </div>`;
      });

      if (recentUploadsScroller) {
        recentUploadsScroller.innerHTML = html;
        // Re-attach open-comments listeners for newly injected content
        attachOpenCommentsListeners(recentUploadsScroller);
      }
    })
    .catch(function(error){
      console.error('Error:', error);
      var loadingIndicator = document.getElementById('loadingIndicator');
      var recentUploadsScroller = document.getElementById('recentUploadsScroller');
      if (loadingIndicator) loadingIndicator.classList.add('hidden');
      if (recentUploadsScroller) recentUploadsScroller.innerHTML = `
        <div class="text-center text-red-400 text-sm border border-dashed border-[#374151] rounded-2xl py-10 bg-[#050819]">
          <p class="mb-2">‚ö†Ô∏è</p>
          <p>Error loading artworks. Please try again.</p>
        </div>`;
    });
  });

  // Helper to attach comment button handlers to dynamically added elements
  function attachOpenCommentsListeners(container) {
    container = container || document;
    var openButtons = container.querySelectorAll('.open-comments');
    var commentsPanel = document.getElementById('commentsPanel');
    var commentsFrame = document.getElementById('commentsFrame');

    openButtons.forEach(function(btn) {
      // Remove any existing to avoid duplicates
      btn.removeEventListener('click', openCommentsHandler);
      btn.addEventListener('click', openCommentsHandler);
    });

    function openCommentsHandler(e) {
      e.preventDefault();
      var url = this.getAttribute('data-comments-url');
      if (!url) { console.error('No comments URL found'); return; }

      if (commentsFrame) commentsFrame.src = url;
      if (commentsPanel) commentsPanel.classList.remove('hidden');

      // prevent background scroll and add backdrop
      document.body.style.overflow = 'hidden';
      if (!document.getElementById('commentsBackdrop')) {
        document.body.insertAdjacentHTML('beforeend', '<div id="commentsBackdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40"></div>');
        var backdrop = document.getElementById('commentsBackdrop');
        if (backdrop) backdrop.addEventListener('click', function(){
          // reuse close handler if available
          if (typeof closeCommentsPanelHandler === 'function') closeCommentsPanelHandler();
          else { commentsPanel.classList.add('hidden'); document.body.style.overflow = ''; if (backdrop) backdrop.remove(); }
        });
      }
    }
  }

});
</script>

<!-- JS -->

<!-- JS -->
<script src="{% static 'js/navigation.js' %}"></script>
<script src="{% static 'js/cards.js' %}"></script>
<script src="{% static 'js/portfolio.js' %}"></script>
<script src="{% static 'js/chat.js' %}"></script>
<script src="{% static 'js/timeline.js' %}"></script>
<script src="{% static 'js/animations.js' %}"></script>
<script src="{% static 'js/notifications.js' %}"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
<script src="{% static 'js/favorites.js' %}"></script>
<script src="{% static 'js/comments.js' %}"></script>
<script src="{% static 'js/messages.js' %}"></script>
<script src="{% static 'js/collab.js' %}"></script>
<script src="{% static 'js/activity.js' %}"></script>
<script src="{% static 'js/simple-category-filter.js' %}"></script>

{% endblock %}